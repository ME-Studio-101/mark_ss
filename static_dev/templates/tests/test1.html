{% extends "base.html" %}
{% load static %}


{% block meta_description %}О нас{% endblock %}


{% block styles %}
<link rel="stylesheet" href="{% static 'css/pages/tests/_vars-test1.css' %}">
<!-- Стили для экранов до 575px -->
<link rel="stylesheet" href="{% static 'css/pages/tests/_build-test1.css' %}">
{% endblock %}


{% block main %}
<!-- Тест 1 -->
<div class="ss_container">
  <div id="test1">
    <div id="test1_content_container">
      <h2><span class="gradient_text">Test 1 - check your vocabulary level</span></h2>
      <p>Choose the words that you know</p>
      <div class="test1_words">
        {% for word in words %}
        <button type="button" class="word_button">{{ word }}</button>
        {% endfor %}
      </div>
      <!-- В конце первого теста -->
      <div class="next-test-button" id="next-test1-button">
        <button onclick="scrollToTest('test2')">
          Перейти ко второму тесту
          <i class="bi bi-arrow-right-circle-fill ms-2"></i>
        </button>
      </div>
    </div>
  </div>
</div>



<!-- Тест 2 -->
<div class="ss_container">
  <div id="test2">
    <div id="test2_content_container">
      <h2><span class="gradient_text">Test 2 - Check your grammar</span></h2>
      {% for question in questions %}
      <div class="test2_case" data-correct-answer="{{ question.correct_answer }}">
        <h4>
          {{ forloop.counter }}. {{ question.question }}
        </h4>
        <div class="test2-radio">
          <input class="test2_radio-input" type="radio" name="test2-q{{ forloop.counter }}"
            id="test2-q{{ forloop.counter }}-a">
          <label class="test2_radio-label" for="test2-q{{ forloop.counter }}-a">
            {{ question.answer1 }}
          </label>
        </div>
        <div class="test2-radio">
          <input class="test2_radio-input" type="radio" name="test2-q{{ forloop.counter }}"
            id="test2-q{{ forloop.counter }}-b">
          <label class="test2_radio-label" for="test2-q{{ forloop.counter }}-b">
            {{ question.answer2 }}
          </label>
        </div>
        <div class="test2-radio">
          <input class="test2_radio-input" type="radio" name="test2-q{{ forloop.counter }}"
            id="test2-q{{ forloop.counter }}-c">
          <label class="test2_radio-label" for="test2-q{{ forloop.counter }}-c">
            {{ question.answer3 }}
          </label>
        </div>
      </div>
      {% endfor %}

      <!-- В конце второго теста -->
      <div class="next-test-button" id="next-test2-button">
        <button onclick="scrollToTest('test3')">
          Перейти к третьему тесту
          <i class="bi bi-arrow-right-circle-fill ms-2"></i>
        </button>
      </div>
    </div>
  </div>
</div>



<!-- Тест 3 -->
<div class="ss_container">
  <div id="test3">
    <div id="test3_content_container">
      <img src="{% static 'img/test3_dcloud.png' %}">
      <h2><span class="gradient_text">Test 3 - Listening</span></h2>
      <h3>Переписка с другом</h3>
      <p>
        Представьте, что увидели своего друга<br class="br_none br_sm"> онлайн и решили написать<br
          class="br_none br_lg br_md">
        ему. С какой<br class="br_none br_sm"> фразы вы начнете диалог?
      </p>
      <div id="test3_case-question-a" class="test3_case-question">
        <button class="word_button-t3 test3-qa-a" data-correct="true">Hello, how are you?</button>
        <button class="word_button-t3 test3-qa-b">Hi! Where are you?</button>
        <button class="word_button-t3 test3-qa-c">Hi! Can you help me?</button>
      </div>
      <div id="test3_case-answer-b" class="test3_case-answer hidden">
        <div class="audio-player">
          <audio id="audio-b" src="{% static 'audio/voice_messaging_A2_01.mp3' %}"></audio>
          <button id="play-pause-b" class="audio-player-btn"><i class="bi bi-play-fill apbi-ml2"></i></button>
          <input type="range" id="progress-bar-b" value="0" max="100">
          <span class="audio-time">00:00</span>
        </div>
      </div>
      <div id="test3_case-question-b" class="test3_case-question hidden">
        <button class="word_button-t3 test3-qb-a">I’m going to France.</button>
        <button class="word_button-t3 test3-qb-b" data-correct="true">Yes, it’s really nice here.</button>
        <button class="word_button-t3 test3-qb-c">Oh, I’m really excited about it.</button>
      </div>
      <div id="test3_case-answer-c" class="test3_case-answer hidden">
        <div class="audio-player">
          <audio id="audio-c" src="{% static 'audio/voice_messaging_B1_01.mp3' %}"></audio>
          <button id="play-pause-c" class="audio-player-btn"><i class="bi bi-play-fill apbi-ml2"></i></button>
          <input type="range" id="progress-bar-c" value="0" max="100">
          <span class="audio-time">00:00</span>
        </div>
      </div>
      <div id="test3_case-question-c" class="test3_case-question hidden">
        <button class="word_button-t3 test3-qc-a">Yeah, it has something in common with my
          job.</button>
        <button class="word_button-t3 test3-qc-b" data-correct="true">Yeah, it has to do with some work-related stuff.</button>
        <button class="word_button-t3 test3-qc-c">Yeah, unfortunately, it doesn’t work for me.</button>
      </div>
      <div id="test3_case-answer-d" class="test3_case-answer hidden">
        <div class="audio-player">
          <audio id="audio-d" src="{% static 'audio/voice_messaging_B2_01.mp3' %}"></audio>
          <button id="play-pause-d" class="audio-player-btn"><i class="bi bi-play-fill apbi-ml2"></i></button>
          <input type="range" id="progress-bar-d" value="0" max="100">
          <span class="audio-time">00:00</span>
        </div>
      </div>
      <div id="test3_case-question-d" class="test3_case-question hidden">
        <button class="word_button-t3 test3-qd-a">What a relief!</button>
        <button class="word_button-t3 test3-qd-b" data-correct="true">So you paid a pretty penny for them, didn’t you?</button>
        <button class="word_button-t3 test3-qd-c">Sounds like a bargain!</button>
      </div>
      <div id="test3_case-answer-e" class="test3_case-answer hidden">
        <div class="audio-player">
          <audio id="audio-e" src="{% static 'audio/voice_messaging_C1_01.mp3' %}"></audio>
          <button id="play-pause-e" class="audio-player-btn"><i class="bi bi-play-fill apbi-ml2"></i></button>
          <input type="range" id="progress-bar-e" value="0" max="100">
          <span class="audio-time">00:00</span>
        </div>
      </div>
      <div id="test3_case-question-e" class="test3_case-question hidden">
        <button class="word_button-t3 test3-qe-a" data-correct="true">Sure, I’ll bring an umbrella.</button>
        <button class="word_button-t3 test3-qe-b">No problem, let’s keep in touch.</button>
        <button class="word_button-t3 test3-qe-c">OK, I’ll check the weather forecast and let you know.</button>
      </div>

      <!-- В конце третьего теста -->
      <div class="next-test-button hidden" id="next-test3-button">
        <button>
          Посмотреть результаты
          <i class="bi bi-award-fill ms-2"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 
<button id="check-answers" class="btn btn-primary">Проверить ответы</button> -->
{% endblock %}


{% block scripts-after %}
<!-- Под вопросом -->
<script src="{% static 'js/courses/courses_scroll_buttons.js' %}"></script>
<script src="{% static 'js/index/horizontal_scroll_spy.js' %}"></script>
<!-- Скрипт для проверки ответов -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let correctCountTest1 = 0; // Счетчик правильных ответов для первого теста
    let correctCountTest2 = 0; // Счетчик правильных отетов для вторго теста
    let correctCountTest3 = 0; // Счетчик правильных ответов для третьего теста

    // Обработка нажатий для первого теста
    const buttonsTest1 = document.querySelectorAll('.word_button');
    buttonsTest1.forEach(button => {
      button.addEventListener('click', function () {
        if (button.classList.toggle('selected')) {
          correctCountTest1++;
        }
      });
    });

    // Обработка нажатий для второго теста
    const questionsTest2 = document.querySelectorAll('.test2_case');
    questionsTest2.forEach((question, index) => {
      const correctAnswer = question.getAttribute('data-correct-answer');
      const options = question.querySelectorAll('input[type="radio"]');
      options.forEach(option => {
        option.addEventListener('change', function () {
          if (option.checked && option.id.endsWith(correctAnswer)) {
            correctCountTest2++;
          }
        });
      });
    });

    // Обработка нажатий для третьего теста
    const questionGroupsTest3 = document.querySelectorAll('.test3_case-question');
    questionGroupsTest3.forEach(group => {
      const buttons = group.querySelectorAll('.word_button-t3');
      buttons.forEach(button => {
        button.addEventListener('click', function (event) {
          buttons.forEach(btn => {
            if (btn !== event.currentTarget) {
              btn.classList.add('disabled');
              btn.disabled = true;
            }
            if (btn.dataset.correct === "true") {
              btn.classList.add('correct');
            } else {
              btn.classList.add('incorrect');
            }
          });

          event.currentTarget.classList.add('selected');
          if (event.currentTarget.dataset.correct === "true") {
            correctCountTest3++;
          }

          const currentQuestion = event.currentTarget.parentElement;
          const nextAnswer = currentQuestion.nextElementSibling;
          const nextQuestion = nextAnswer ? nextAnswer.nextElementSibling : null;

          if (nextAnswer) {
            setTimeout(() => {
              nextAnswer.classList.remove('hidden');
              nextAnswer.classList.add('visible-1');
            }, 1000); // Задержка в 1 секунду перед появлением первого элемента
          }
          if (nextQuestion) {
            nextQuestion.classList.remove('hidden');
            nextQuestion.classList.add('visible-2');
          }
        });
      });
    });

    // Добавляем обработчик для кнопки результатов
    document.getElementById('next-test3-button').querySelector('button').addEventListener('click', function() {
        let correctCountTest1 = 0;
        let correctCountTest2 = 0;
        let correctCountTest3 = 0;

        // Подсчет для первого теста
        const selectedWords = document.querySelectorAll('.word_button.selected');
        correctCountTest1 = selectedWords.length;

        // Подсчет для второго теста
        const questionsTest2 = document.querySelectorAll('.test2_case');
        questionsTest2.forEach(question => {
            const correctAnswer = question.getAttribute('data-correct-answer');
            const selectedOption = question.querySelector(`input[id$="${correctAnswer}"]:checked`);
            if (selectedOption) correctCountTest2++;
        });

        // Подсчет для третьего теста
        const correctAnswersTest3 = document.querySelectorAll('.test3_case-question .word_button-t3.selected[data-correct="true"]');
        correctCountTest3 = correctAnswersTest3.length;

        // Формируем URL с параметрами и делаем редирект
        const totalCorrect = correctCountTest1 + correctCountTest2 + correctCountTest3;
        const resultsUrl = `/test-results/?correct=${totalCorrect}`;
        window.location.href = resultsUrl;
    });
  });
</script>
<!-- Скрипт для воспроизведения аудио -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const audioPlayers = document.querySelectorAll('.audio-player');
    let loadedAudioCount = 0;
    let maxRetries = 5;
    let retryDelay = 1000; // 1 секунда между попытками

    // Функция инициализации плеера
    function initializeAudioPlayer(player) {
      const audio = player.querySelector('audio');
      const playPauseButton = player.querySelector('button');
      const progressBar = player.querySelector('input[type="range"]');
      const timeDisplay = player.querySelector('.audio-time');

      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
      }

      audio.addEventListener('loadedmetadata', function () {
        timeDisplay.textContent = formatTime(audio.duration);
      });

      audio.addEventListener('timeupdate', function () {
        const progress = (audio.currentTime / audio.duration) * 100;
        progressBar.value = progress;
        timeDisplay.textContent = formatTime(audio.currentTime);
      });

      playPauseButton.addEventListener('click', function () {
        if (audio.paused) {
          audio.play();
          playPauseButton.innerHTML = '<i class="bi bi-pause-fill"></i>';
        } else {
          audio.pause();
          playPauseButton.innerHTML = '<i class="bi bi-play-fill apbi-ml2"></i>';
        }
      });

      progressBar.addEventListener('input', function () {
        const seekTime = (progressBar.value / 100) * audio.duration;
        audio.currentTime = seekTime;
      });
    }

    // Функция для попытки загрузки аудо
    function tryLoadAudio(audio, player, currentRetry = 0) {
      return new Promise((resolve, reject) => {
        // Таймаут для текущей попытки
        const timeout = setTimeout(() => {
          if (currentRetry < maxRetries) {
            console.log(`Retry loading audio ${currentRetry + 1}/${maxRetries}:`, audio.src);
            audio.load(); // Перезагрузка аудио
            tryLoadAudio(audio, player, currentRetry + 1)
              .then(resolve)
              .catch(reject);
          } else {
            console.error('Failed to load audio after all retries:', audio.src);
            reject(new Error('Audio load timeout'));
          }
        }, retryDelay);

        // Обработчики событий загрузки
        const successHandler = () => {
          clearTimeout(timeout);
          audio.removeEventListener('loadeddata', successHandler);
          audio.removeEventListener('error', errorHandler);
          resolve();
        };

        const errorHandler = (error) => {
          clearTimeout(timeout);
          audio.removeEventListener('loadeddata', successHandler);
          audio.removeEventListener('error', errorHandler);
          if (currentRetry < maxRetries) {
            tryLoadAudio(audio, player, currentRetry + 1)
              .then(resolve)
              .catch(reject);
          } else {
            console.error('Error loading audio:', error);
            reject(error);
          }
        };

        audio.addEventListener('loadeddata', successHandler);
        audio.addEventListener('error', errorHandler);
      });
    }

    // Функция инициализации всех плееров
    async function initializeAllPlayers() {
      const loadPromises = Array.from(audioPlayers).map(player => {
        const audio = player.querySelector('audio');
        return tryLoadAudio(audio, player)
          .then(() => {
            loadedAudioCount++;
            console.log(`Audio loaded (${loadedAudioCount}/${audioPlayers.length}):`, audio.src);
          })
          .catch(error => {
            console.error('Final audio load error:', error);
            loadedAudioCount++;
          });
      });

      // Ждем загрузки всех аудио
      await Promise.all(loadPromises);

      // Когда все аудиофайлы загружены, инициализируем плееры
      audioPlayers.forEach(initializeAudioPlayer);
    }

    // Проверяем загрузку каждого аудиофайла
    audioPlayers.forEach(player => {
      const audio = player.querySelector('audio');

      // Обработчик успешной загрузки
      audio.addEventListener('loadeddata', function () {
        loadedAudioCount++;

        // Когда все аудиофайлы загружены, иницализируе плееры
        if (loadedAudioCount === audioPlayers.length) {
          initializeAllPlayers();
        }
      });

      // Обработчик ошибки загрузки
      audio.addEventListener('error', function () {
        console.error('Error loading audio file:', audio.src);
        loadedAudioCount--;
      });
    });
  });
</script>
<!-- В блоке scripts-after добавим новый скрипт -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Получаем все тесты и кнопки
    const test1 = document.getElementById('test1');
    const test2 = document.getElementById('test2');
    const test3 = document.getElementById('test3');

    // Изначально показываем только первый тест
    test2.style.display = 'none';
    test3.style.display = 'none';

    // Функция для плавного скролла и переключения тестов
    function switchToTest(fromTest, toTest) {
      // Плавно скрываем текущий тест
      fromTest.style.opacity = '0';
      fromTest.style.transition = 'opacity 0.5s ease';

      setTimeout(() => {
        // Скрываем предыдущий тест
        fromTest.style.display = 'none';

        // Показываем следующий тест
        toTest.style.display = 'block';
        toTest.style.opacity = '0';

        // Небольшая задержка перед показом для анимации
        setTimeout(() => {
          toTest.style.opacity = '1';
          toTest.style.transition = 'opacity 0.5s ease';

          // Плавный скролл к началу следующего теста
          toTest.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 50);
      }, 500);
    }

    // Обработчики для кнопок навигации
    document.getElementById('next-test1-button').addEventListener('click', function () {
      switchToTest(test1, test2);
    });

    document.getElementById('next-test2-button').addEventListener('click', function () {
      switchToTest(test2, test3);
    });

    // Добавляем CSS для плавных переходов
    const style = document.createElement('style');
    style.textContent = `
        #test1, #test2, #test3 {
            transition: opacity 0.5s ease;
        }
    `;
    document.head.appendChild(style);

    // Добавим обработчики для последнего теста
    const test3Questions = document.querySelectorAll('#test3 .test3_case-question');
    const lastQuestionButtons = test3Questions[test3Questions.length - 1].querySelectorAll('.word_button-t3');
    
    // Показываем кнопку результатов после ответа на последний вопрос
    lastQuestionButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Даем небольшую задержку для анимации ответа
            setTimeout(() => {
                document.getElementById('next-test3-button').classList.remove('hidden');
            }, 1000);
        });
    });
  });
</script>
{% endblock %}